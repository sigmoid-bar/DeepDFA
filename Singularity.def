Bootstrap: docker
From: nvcr.io/nvidia/cuda:12.3.1-runtime-ubuntu22.04
Stage: spython-base

%files
environment.yml .
scripts/install_joern.sh .
. .
%post

# Install dependencies
apt clean && \
apt update -y && \
apt install -y \
curl git build-essential \
openjdk-11-jdk unzip

# Install conda
curl -O https://repo.anaconda.com/miniconda/Miniconda3-py311_23.10.0-1-Linux-x86_64.sh \
&& mkdir /root/.conda \
&& bash Miniconda3-py311_23.10.0-1-Linux-x86_64.sh -b -u -p /opt/conda \
&& rm -f Miniconda3-py311_23.10.0-1-Linux-x86_64.sh
PATH=/opt/conda/bin:$PATH

mkdir /DeepDFA
mkdir -p /DeepDFA
cd /DeepDFA

# Create environment
conda env create -f environment.yml && \
conda init bash && \
echo "conda activate deepdfa" >> $HOME/.bashrc
LD_LIBRARY_PATH=/opt/conda/envs/deepdfa/lib:$LD_LIBRARY_PATH
PYTHONPATH=/DeepDFA/DDFA:$PYTHONPATH

# Install Joern
bash install_joern.sh
PATH=/DeepDFA/joern/joern-cli:$PATH

%environment
export PATH=/opt/conda/bin:$PATH
export LD_LIBRARY_PATH=/opt/conda/envs/deepdfa/lib:$LD_LIBRARY_PATH
export PYTHONPATH=/DeepDFA/DDFA:$PYTHONPATH
export PATH=/DeepDFA/joern/joern-cli:$PATH
%runscript
cd /DeepDFA
exec /bin/bash "$@"
%startscript
cd /DeepDFA
exec /bin/bash "$@"
